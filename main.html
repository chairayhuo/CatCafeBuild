<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>CAT CAFE DEMO</title>

    <!-- zimjs.com - JavaScript Canvas Framework -->
    <script type=module>

import zim from "https://zimjs.com/cdn/015/zim_game";

const assets = ["BabyDoll.ttf", "blackcat.png", "orangecat.png", "whitecat.png","tuxcat.png","milk.png","food.png","brush.png","background.png","winning.png"];
const path = "assets/"

// See Docs under Frame for FIT, FILL, FULL, and TAG
new Frame(FIT, 1024, 768, light, dark, ready, assets, path);
function ready() {

const background = new Pic("background.png").sca(.85).center();

let score = new Scorer({
    font:"BabyDoll.ttf",
    backgroundColor:orange,
    borderColor: black,
    borderWidth:3,
    width:60
}).pos(50,50,RIGHT);

const timer = new Timer({
    startPaused:true,
    font:"BabyDoll.ttf",
    backgroundColor:orange,
    borderColor: black,
    borderWidth:3,
    width:60
}).pos(50,50);

S.on("stagemousedown", ()=>{              
    timer.start();    
}, null, true); 

S.update();

let spotA = new Container(150, 150).loc(300,310).outline().reg(CENTER);
let spotB = new Container(150, 150).loc(70,390).outline().reg(CENTER);
let spotC = new Container(150, 150).loc(500,320).outline().reg(CENTER);
let spotD = new Container(150, 150).loc(870,220).outline().reg(CENTER);
    
let spots = [spotA, spotB, spotC, spotD];

// const blackcat = new Pic("blackcat.png").pos(50, 150, LEFT, TOP);
// const orangecat = new Pic("orangecat.png").pos(100, 150, RIGHT, TOP);
// const whitecat = new Pic("whitecat.png").pos(50, 150, LEFT, BOTTOM);
// const tuxcat = new Pic("tuxcat.png").pos(50, 150, RIGHT, BOTTOM);

const blackcat = new Pic("blackcat.png");
const orangecat = new Pic("orangecat.png");
const whitecat = new Pic("whitecat.png");
const tuxcat = new Pic("tuxcat.png");

// let blackTimer = new Timer({
//         time: 15,
//         font:"BabyDoll.ttf",
//         backgroundColor:white,
//         borderColor: black,
//         borderWidth:3,
//         width:60
//     }).addTo(blackcat).pos(130,15);
//     let orangeTimer = new Timer({
//         time: 15,
//         font:"BabyDoll.ttf",
//         backgroundColor:white,
//         borderColor: black,
//         borderWidth:3,
//         width:60
//     }).addTo(orangecat).pos(135,-10);

//     let whiteTimer = new Timer({
//         time: 12,
//         font:"BabyDoll.ttf",
//         backgroundColor:white,
//         borderColor: black,
//         borderWidth:3,
//         width:60
//     }).center(whitecat);

//     let tuxTimer = new Timer({
//         time: 10,
//         font:"BabyDoll.ttf",
//         backgroundColor:white,
//         borderColor: black,
//         borderWidth:3,
//         width:60
//     }).addTo(tuxcat).pos(135,5);

// let catTimers = [blackTimer, orangeTimer, whiteTimer,tuxTimer];

let cats = [
    { pic: blackcat, accepting: ["milk", "food", "brush"],time:15},
    { pic: orangecat, accepting: ["milk", "food", "brush"],time:15},
    { pic: whitecat, accepting: ["milk", "food", "brush"],time:12},
    { pic: tuxcat, accepting: ["milk", "food", "brush"],time:10}
];

function placeRandomCat(spots) {
    // zog("placeRandomCat called for spot: ", spots);
    let randomCatData = pluck(cats);

    let catsPic = ["blackcat.png","orangecat.png","whitecat.png","tuxcat.png"];
    let randomCatFile = pluck(catsPic); 
    let randomCatPic = new Pic(randomCatFile);

    let randomCatTimer = new Timer({
        time: randomCatData.time,
        font:"BabyDoll.ttf",
        backgroundColor:white,
        borderColor: black,
        borderWidth:3,
        width:60
    }).center();

    randomCatPic.addTo(spots).scaleTo(spots);
    // randomCatTimer.addTo(randomCatPic).centerReg();
    randomCatTimer.addTo(spots);
    randomCatTimer.pos(randomCatPic.x, randomCatPic.y + randomCatPic.height); 
    zog("Timer set for: " + randomCatData.time + " seconds");
    

    // 设置猫离开的计时器
    let catTimers = setTimeout(() => {
        zog("Timer finished, removing cat and timer");
        // 猫离开的逻辑
        // spot.removeChild(randomCatPic);
        randomCatPic.removeFrom(spots);
        randomCatTimer.removeFrom(spots);
        // 等待3秒后放置新的猫
        setTimeout(() => placeRandomCat(spots), rand(1000,3000));
    }, randomCatData.time*1000); // 使用猫的计时器时长
    zog(randomCatData.time*1000);

    // 如果猫被满足，清除计时器并立即触发离开动作
    // randomCatPic.on("click", () => {
    //     clearTimeout(catTimers);
    //     // spot.removeChild(randomCatPic);
    //     randomCatPic.removeFrom(spots);
    //     setTimeout(() => placeRandomCat(spots), 3);
    // });
}

placeRandomCat(spotA);
placeRandomCat(spotB);
placeRandomCat(spotC);
placeRandomCat(spotD);

const milkC = new Container(100, 100).pos(100, 100, LEFT, BOTTOM);
const foodC = new Container(100, 100).pos(0, 50, CENTER, BOTTOM);
const brushC = new Container(100, 100).pos(150, 50, RIGHT, BOTTOM);

let item;

loop(10, () => {
    let milk = new Pic("milk.png").addTo(milkC).scaleTo(milkC).drag();
    milk.name="milk";
    let food = new Pic("food.png").addTo(foodC).scaleTo(foodC).drag();
    food.name="food";
    let brush = new Pic("brush.png").addTo(brushC).scaleTo(brushC).drag();
    brush.name="brush";
    S.update();

    // [milk, food, brush].forEach(item => {
        loop([milk, food, brush],item=>{
        item.startX = item.x;
        item.startY = item.y;
        item.on("pressup", () => checkItem(item));
        S.update();
    });
});

let finalScore;

function checkItem(item,i) {
    // cats.forEach(cat => {    
    loop(cats,(cat) =>{
        if (item.hitTestBounds(cat.pic)) {
            zog(cat.accepting);
            if (cat.accepting.includes(item.name)) {
            
            item.dispose();
            zog(item.name);
            
            // cat.accepting = cat.accepting.filter(acceptedItem => acceptedItem !== item.name);
            cat.accepting = cat.accepting.filter(i => i !== item.name);
            zog(cat.accepting);

            S.update();

            if (cat.accepting.length === 0) {
                animateCatOffScreen(cat.pic);
                score.score++;
                finalScore = score.score;
                zog(finalScore);
                zog(score.score);
            }      
        }else{
            zog(item.name);
            zog(cat.accepting);
            item.animate({ x: item.startX, y: item.startY }, 0.3);
        } 
        }else {            
            item.animate({ x: item.startX, y: item.startY }, 0.3);
        }
    });
}

function animateCatOffScreen(cat) {
    cat.animate({
        props:[
            {props:{y:cat.y-20},time:.5, ease: "bounceIn"},
            {props:{y:cat.y+20},time:.7, ease: "bounceOut"},
            {props:{x:-500, y:50}, time: 5, ease:"backOut"}
        ]
    })
};

const winningComments = {
    0: "Looks like you've got a bit of a 'cat-astrophe' on your hands! Remember, practice makes 'purr-fect'!",
    1: "You're just starting to 'paw' your way to success! Keep going and you'll be the cat's meow in no time!",
    6: "You're getting your 'claws' into it! Keep up the good work and you'll be a 'purr'-fessional soon!",
    11: "Look at you, a 'whisker' away from being a top cat carer! Keep those treats coming!",
    16: "You're the cat's 'whiskers'! Just a little more and you'll be the ultimate cat companion!",
    21: "You're the 'purr-fect' cat caretaker! All the kitties are 'feline' good thanks to your expert care!",
    26: "You're a legendary cat whisperer! Even the most finicky felines find you 'paw-some'!"
};

let comment = "";

function displayWinningComment(finalScore) {
    
    if (finalScore === 0) {
        comment = winningComments[0];
    } else if (finalScore >= 1 && finalScore <= 5) {
        comment = winningComments[1];
    } else if (finalScore >= 6 && finalScore <= 10) {
        comment = winningComments[6];
    } else if (finalScore >= 11 && finalScore <= 15) {
        comment = winningComments[11];
    } else if (finalScore >= 16 && finalScore <= 20) {
        comment = winningComments[16];
    } else if (finalScore >= 21 && finalScore <= 25) {
        comment = winningComments[21];
    } else if (finalScore > 25) {
        comment = winningComments[26];
    }
    zog(comment);
}

function winningPage(){

    new Pic("winning.png").center().alp(0).animate({alpha: 1}, 1);

    new Label({
        text:"Your final score is",
        size:60,
        font:"BabyDoll.ttf",
    }).centerReg().pos(0,180,CENTER,TOP).alp(0).sca(0).animate({scale:1,alpha:1}, 1.7, "elasticOut",null,null,1);

    const scoreText = new Label({
        text:finalScore,
        size:72,
        backgroundColor:orange,
        corner:10,
        font:"BabyDoll.ttf",
    }).centerReg().pos(0,280,CENTER,TOP).alp(0).sca(0).animate({scale:1,alpha:1}, 1.7, "elasticOut",null,null,2);

    new Label({
        text:comment,
        shadowColor:white,
        labelWidth:800,
        labelHeight:180,
        align:CENTER,
        valign:MIDDLE,
        font:"BabyDoll.ttf",
        splitWords:true
    }).pos(0,180,CENTER,BOTTOM).alp(0).animate({alpha: 1}, 1,null,null,null,3);

    STYLE = {
		font:"BabyDoll.ttf", 
		size:70, 
		color:yellow,
		bold:true,
		letterSpacing:8,
		lineSpacing:50,
		lineAlign:CENTER
	};

    const text = new LabelLetters("meow")
		.centerReg()
        .pos(20,100,LEFT,TOP)
		.sca(0)
		.animate({scale:1}, 3, "elasticOut",null,null,4);

	const colors = series(red,blue,purple,green,pink);

	text.loop(letter=>{
		letter.sha(colors().toAlpha(.5),8,8,0).wiggle("rotation",0,5,10,.2,.4);
	});

    const text2 = new LabelLetters("purr")
		.centerReg()
        .pos(20,120,RIGHT,BOTTOM)
		.sca(0)
		.animate({scale:1}, 3, "elasticOut",null,null,4); 
	
    text2.loop(letter=>{
		letter.sha(colors().toAlpha(.5),8,8,0).wiggle("rotation",0,5,10,.2,.4);
	});
    
    STYLE = {};
}

timer.on("complete", () => {
    zog(finalScore);
    setTimeout(() => {
    displayWinningComment(finalScore);
    winningPage();
    }, 2); 
});


}


</script>
    <meta name="viewport" content="width=device-width, user-scalable=no" />
</head>

<body></body>

</html>